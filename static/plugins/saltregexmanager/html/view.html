<!--
 Obdi - a REST interface and GUI for deploying software
 Copyright (C) 2014  Mark Clarkson

 This program is free software: you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation, either version 3 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<!-- tool_content -->

<script type="text/ng-template" id="myModalContent.html">
    <div class="modal-header">
        <h3 class="modal-title">Delete Key</h3>
    </div>
    <div class="modal-body">
      Are you sure you want to delete '{{servername}}'?
    </div>
    <div class="modal-footer">
        <button class="btn btn-danger" ng-click="ok()">Yes</button>
        <button class="btn btn-primary" ng-click="cancel()">No</button>
    </div>
</script>

<div ng-controller="saltregexmgrCtrl">

  <div class="row">
    <div class="col-lg-12">
      <h3 class="page-header">Map Classes to Hosts
      <button class="btn btn-sm btn-success pull-right" type="button"
        ng-if="envchosen.shown" ng-click="Restart()" style="margin-top: -5px;">
        <i class="fa fa-refresh"> </i> Restart</button>
      <button class="btn btn-sm btn-default pull-right" type="button"
      ng-if="envsetting.shown || mapconfig.shown" ng-click="GoBack()"
      style="margin-top: -5px;">
        <i class="fa fa-arrow-left"> </i> Go Back</button>
      <button class="btn btn-sm btn-success pull-right" type="button"
      ng-if="envsetting.shown" ng-disabled="forminvalid"
      ng-click="ApplySettings()"
      style="margin-top: -5px; margin-right:8px;">
        <i class="fa fa-check"> </i> Apply</button>
      </h3>
    </div>
  </div>

  <div class="row" ng-if="!mapconfig.shown">
    <div class="col-sm-12">

      Use this page to select classes (formulas and state files) that should
      be assigned to hosts. The assignment is based on comparing host names to
      lists of regular expressions. These classes will only be applied to new
      hosts, or for hosts that have had their classes deleted completely.

    </div>
  </div>

  <div class="row">
    <div class="col-sm-12">
      <div class="alert alert-success alert-dismissable" ng-show="okmessage">
        <button type="button" class="close" data-dismiss="alert"
          aria-hidden="true">&times;</button>
        {{okmessage}}
      </div>
      <div class="alert alert-danger alert-dismissable" ng-show="message">
        <button type="button" class="close" data-dismiss="alert"
          aria-hidden="true">&times;</button>
        {{message}}
        <span ng-if="message_jobid">
        See: <a href="#" ng-click="showOutputlines(message_jobid)">
        jobid:{{message_jobid}}</a> 
        </span>
      </div>
    </div>
  </div>

  <div class="row" ng-if="!showkeybtnblockhidden">
    <div class="col-sm-12" style="margin-top: 20px">
      <div style="margin-left: 14px" class="btn-group"
      dropdown is-open="status.isopen">
        <button type="button" class="btn btn-primary dropdown-toggle"
        ng-disabled="btnenvlistdisabled">
          Choose Environment <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
          <li ng-repeat="choice in environments">
          <a href ng-click="envChoice(choice, $event)">
            {{choice.DcSysName}} {{choice.SysName}}</a>
          </li>
        </ul>
      </div>
      <div class="btn-group">
        <button type="button" class="btn btn-primary dropdown-toggle"
        style="margin-left: 8px;" 
        ng-click="RegexList()" ng-disabled="btnshowkeysdisabled">
          Show Host Mappings
        </button>
      </div>
    </div>
  </div>

  <!-- MAIN KEY MGMT PAGE -->

  <div class="row" ng-if="envchosen.shown">
    <div class="col-sm-12">

      <h4 class="page-header">{{env.DcDispName}} - {{env.DispName}}</h4>

      <p ng-if="!btnshowkeysdisabled">Press the Show Server Keys button above
      to get the list of keys from Salt.</p>

      <div ng-if="listbtnpressed">
        <p ng-if="!regexlist_ready && !message">Getting the regular expressions
        list. This might take a while
        <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i></p>

        <p ng-if="regexlist_ready && regexlist_empty">Salt reports that this
        environment contains no server keys!<br />
        </p>

        <div ng-if="regexlist_ready && !regexlist_empty">

          <!-- <p class="big"></p> -->

          <div class="table-responsive" style="margin-top: 8px;">
            <table class="table table-striped table-bordered">
              <thead>
              <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Action</th>
              </tr>
              </thead>
              <tbody>
                <tr ng-repeat="item in regexlist | filter:keyfilter">
                <td>{{item.Name}}</td>
                <td>
                  {{item.Desc}}<br />&nbsp;<br />Regex:
                  <p style="margin-left: 16px; font-family:monospace;
                  color: blue;">
                    {{item.Regex}}
                  </p>
                </td>
                <td>
                  <a href="#" ng-click="dialog(item.Name)">
                    <i class="fa fa-trash-o red" title="Delete Regex"></i></a>
                  <a href="#" ng-click="MapConfig(item.Id,item.Name)">
                    <i class="fa fa-cog" title="Configure classes"></i></a>
                </td>
              </tr>
              </tbody>
            </table>
          </div> <!-- table-responsive -->
          <div ng-if="regexlist_empty">
            <p>There are no regexes for this environment.</p>
          </div>

        </div> <!-- serverlist_ready -->

      </div> <!-- listbtnpressed -->
    </div> <!-- col-sm-12 -->
  </div> <!-- row -->

  <!-- ENVIRONTMENT SETTING PAGE -->

  <div class="row" ng-if="mapconfig.shown">
    <div class="col-sm-12">

      <div ng-if="!mapconfig.maplist_ready && !message">
        <h5>
          Getting class details from server
          <i class="ellipsis"><i>.</i><i>.</i><i>.</i></i></p>
        </h5>
      </div>

      <div ng-if="mapconfig.maplist_ready && !message">

        <p class="big">Showing settings for the '{{mapconfig.regx_name}}'
        regular expression.</p>

        <!--
        <p class="append-sm-2">The Datacentre, Environment and Version fields
        shown below correspond respectively to the grains: dc, env and
        version, on the remote server, {{envsetting.saltid}}.</p>
        -->

        <p ng-if="mapconfig.maplist_empty">
        There are no classes assigned!<br />
        </p>

        <div ng-if="!mapconfig.maplist_empty">

          <!-- <p class="big"></p> -->

          <div class="table-responsive" style="margin-top: 8px;">
            <table class="table table-striped table-bordered">
              <thead>
              <tr>
                <th>Formula</th>
                <th>State File</th>
                <th>Action</th>
              </tr>
              </thead>
              <tbody>
                <tr ng-repeat="item in mapconfig.map | filter:mapfilter">
                <td>{{item.Formula}}</td>
                <td>{{item.StateFile}}</td>
                <td>
                  <a href="#" ng-click="dialog(item.Name)">
                    <i class="fa fa-trash-o red" title="Delete Regex"></i></a>
                  <a href="#" ng-click="MapConfig(item.Id,item.Name)">
                    <i class="fa fa-cog" title="Configure classes"></i></a>
                </td>
              </tr>
              </tbody>
            </table>
          </div> <!-- table-responsive -->
          <div ng-if="mapconfig.maplist_empty">
            <p>There are no classes assigned to this regular expression.</p>
          </div>

        </div> <!-- serverlist_ready -->

      </div> <!-- mapconfig.maplist_ready -->

    </div> <!-- col-sm-12 -->
  </div> <!-- row -->

</div>
